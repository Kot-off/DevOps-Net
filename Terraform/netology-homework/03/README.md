# Отчет по домашнему заданию к занятию «Управляющие конструкции в коде Terraform»

## Описание проекта

В данной работе реализована отказоустойчивая и масштабируемая инфраструктура в Yandex Cloud. Основное внимание уделено автоматизации процессов создания ресурсов с помощью управляющих конструкций Terraform, что позволило полностью исключить «хардкод» из конфигурации.

---

## Задание 1: Группы безопасности

Для управления трафиком создана группа безопасности `example_dynamic` с использованием динамических блоков.

* **Решение**: Вместо дублирования кода для каждого порта, использован блок `dynamic "ingress"`, который итерируется по переменной `security_group_ingress`.
* **Результат**: Разрешен входящий трафик для SSH (22), HTTP (80) и HTTPS (443).
* [Документация: Dynamic Blocks](https://www.google.com/search?q=https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks)

*Скриншот 1: Входящие правила группы безопасности в консоли Yandex Cloud.*
![](./images/1.png)

---

## Задание 2: Использование count и for_each

Использовал два типа циклов:

1. **Цикл `count**`: Созданы две идентичные ВМ `web-1` и `web-2`. Это решение оптимально для горизонтального масштабирования веб-серверов.
2. **Цикл `for_each**`: Созданы две ВМ для баз данных `main` и `replica` с индивидуальными настройками CPU и RAM.
3. **Зависимости**: Использован аргумент `depends_on = [yandex_compute_instance.db]` в ресурсе веб-серверов. Это гарантирует, что веб-часть не начнет разворачиваться до полной готовности базы данных.
4. **Экономия**: Для всех ВМ установлена гарантированная доля vCPU `core_fraction = 5` и режим `preemptible = true`.

---

## Задание 3: Динамические диски и Storage VM

Создана специализированная ВМ `storage` с расширяемой дисковой подсистемой:

* С помощью `count` созданы 3 диска по 1 ГБ.
* Через блок **`dynamic "secondary_disk"`** реализовано их автоматическое подключение к ВМ. Такой подход позволяет изменять количество дисков одной цифрой в переменной.

---

## Задание 4: Ansible Inventory

Реализована динамическая генерация файла `hosts` для автоматизации последующей настройки через Ansible.

* **Механизм**: Функция `templatefile` считывает шаблон `hosts.tftpl` и подставляет в него актуальные IP и FQDN всех 5 машин.
* **Результат**: Готовый инвентарь содержит три группы: `[webservers]`, `[databases]` и `[storage]`.
* [Документация: Templatefile Function](https://www.google.com/search?q=https://developer.hashicorp.com/terraform/language/functions/templatefile)

*Скриншот 2: Сгенерированный inventory-файл со всеми активными хостами.*
![](./images/2.png)

---

## Задание 5* (Structured Output)

Для удобства мониторинга настроен `output`, который выводит данные всех созданных машин в виде единого списка объектов (name, id, fqdn).

*Скриншот 3: Вывод структурированных данных о развернутых ресурсах.*
![](./images/3.png)

---

## Задания 7*-9* (Работа в Terraform Console)

В ходе работы с интерактивной консолью выполнены следующие операции:

* **Фильтрация**: Из объекта `local.vpc` удален 3-й элемент списков с помощью конструкции `[for i, v in list : v if i != 2]`.
* **Исправление ошибок**: Устранена ошибка обращения к вложенным структурам в шаблоне `.tftpl`.
* **Генерация списков**: Создан генератор имен серверов `rc01-rc99` с применением условий фильтрации (пропуск определенных окончаний).

---

### Запуск

1. `terraform init` — инициализация проекта и загрузка провайдеров.
2. `terraform plan` — проверка плана создания.
3. `terraform apply -auto-approve` — развертывание инфраструктуры и генерация файла `hosts`.
4. `terraform destroy -auto-approve` — полное удаление ресурсов.

---
