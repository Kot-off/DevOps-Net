Vagrant.configure("2") do |config|
  config.vm.box = "hashicorp-education/ubuntu-24-04"
  config.vm.hostname = "ubuntu-24-netology"  # Исправляем hostname
  
  config.vm.network "private_network", ip: "192.168.56.10"
  config.vm.synced_folder ".", "/vagrant"
  
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
    vb.name = "ubuntu-24-netology"
  end
  
  # Улучшенный provision скрипт
  config.vm.provision "shell", inline: <<-SHELL
    echo "=== Настройка пользователей ==="
    
    # Обязательно обновляем сначала
    apt-get update
    apt-get upgrade -y
    
    # Устанавливаем пароль для root
    echo "root:root123" | chpasswd
    echo "Пароль root установлен"
    
    # Создаем пользователя admin
    if id "admin" &>/dev/null; then
      echo "Пользователь admin уже существует, обновляем пароль"
      echo "admin:admin123" | chpasswd
    else
      echo "Создаем пользователя admin"
      useradd -m -s /bin/bash admin
      echo "admin:admin123" | chpasswd
      usermod -aG sudo admin
      echo "Пользователь admin создан"
    fi
    
    # Также настраиваем пользователя vagrant (стандартный)
    if id "vagrant" &>/dev/null; then
      echo "vagrant:vagrant" | chpasswd
    fi
    
    # Настройка SSH
    echo "Настраиваем SSH..."
    sed -i 's/#?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/#?PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config
    
    # Перезапускаем SSH
    systemctl restart ssh
    echo "SSH перезапущен"
    
    # Показываем созданных пользователей
    echo "=== Созданные пользователи ==="
    echo "root:root123"
    echo "admin:admin123" 
    echo "vagrant:vagrant"
    
    echo "Настройка завершена!"
  SHELL
end